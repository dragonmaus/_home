#!/bin/sh
set -e
home=$(realpath "$0")
home=${home%/*/*}
cd $home

file=$1

echo() { printf '%s\n' "$*"; }

echo '#ifndef SYS_H'
echo '#define SYS_H'

if [[ -r $file.pre ]]
then
	echo
	cat $file.pre
fi

echo
while read -r number name prototype
do
	echo "$prototype"
	if [[ $number = - ]]
	then
		continue
	fi
	cat >$name.s.new <<END
format	elf64

section	'.text' executable

public	$name

$name:
	mov	eax, $number		; syscall $name
	syscall
	ret
END
	cmp -s $name.s.new $name.s || mv -f $name.s.new $name.s
	rm -f $name.s.new
done <$file.list

if [[ -r $file.post ]]
then
	echo
	cat $file.post
fi

echo
echo '#endif'
