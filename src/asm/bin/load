#!/bin/sh
set -e
home=$(realpath "$0")
home=${home%/*/*}
cd $home
main=$1
shift
file=$(ls -f $main.s $main.c 2>/dev/null | head -1)
if [[ -e $main.o && $file -nt $main.o ]]
then
	rm -f $main.o
fi
case $file in
($main.c)
	[[ -e $main.o ]] || bin/compile $file
	;;
($main.s)
	[[ -e $main.o ]] || bin/assemble $file
	;;
esac
if [[ -e $main.o ]]
then
	crt=
	grep -q '^main(' $file && crt=$HOME/lib/crt0.o
	tcc -nostdinc -nostdlib -static -L$HOME/lib -o $main $crt $main.o "$@"
fi
