#!/bin/sh

set -e

home=$(dirname $0)/..
home=$(cd $home && env - pwd)

file=$1

echo() { printf '%s\n' "$*"; }

echo '#ifndef SYS_H'
echo '#define SYS_H'

if [[ -r $file.pre ]]
then
	echo
	cat $file.pre
fi

echo
while read -r number name prototype
do
	echo "$prototype"
	if [[ $number = - ]]
	then
		continue
	fi
	cat >$name.asm.new <<END
format	elf64

section	'.text' executable

public	$name

$name:
	mov	eax, $number		; syscall $name
	syscall
	ret
END
	cmp -s $name.asm.new $name.asm || mv -f $name.asm.new $name.asm
	rm -f $name.asm.new
done <$file.list

if [[ -r $file.post ]]
then
	echo
	cat $file.post
fi

echo
echo '#endif'
